name: Find IPTV Key
on: workflow_dispatch
jobs:
  find_key:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: ğŸ”§ Patch DES3.py
      run: |
        # å®šä½DES3.pyæ–‡ä»¶è·¯å¾„
        DES3_PATH=$(python -c "from Crypto.Cipher import DES3; print(DES3.__file__)")
        echo "æ‰¾åˆ°DES3.pyè·¯å¾„: $DES3_PATH"
        
        # å¤‡ä»½åŸæ–‡ä»¶
        sudo cp $DES3_PATH ${DES3_PATH}.bak
        
        # æ³¨é‡Šæ‰å…³é”®æ£€æŸ¥
        sudo sed -i '/if key_out$$:8$$ == key_out$$8:16$$ or key_out$$-16:-8$$ == key_out$$-8:$$:/,/raise ValueError("Triple DES key degenerates to single DES")/s/^/#/' $DES3_PATH
        echo "å·²æˆåŠŸæ³¨é‡Šæ‰æ£€æŸ¥ä»£ç "
        
        # éªŒè¯ä¿®æ”¹
        grep -A2 "if key_out$$:8$$ == key_out$$8:16$$" $DES3_PATH

    - name: ğŸš€ Run Script
      run: |
        pip install pycryptodome requests
        python get_iptv_channels.py
