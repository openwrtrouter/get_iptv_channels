name: 🔑 Find IPTV Key
on: 
  workflow_dispatch:
    inputs:
      authenticator:
        description: "Paste your Authenticator value here"
        required: true
        type: string

jobs:
  find_key:
    name: 🔍 Find Encryption Key
    runs-on: ubuntu-latest
    timeout-minutes: 360  # Max allowed for free tier
    
    steps:
    - name: 🛠️ Checkout code
      uses: actions/checkout@v4

    - name: 🐍 Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: 📦 Install dependencies
      run: |
        pip install --upgrade pip
        pip install requests pycryptodome

    - name: ⚙️ Apply DES3 patch
      run: |
        cat << 'EOF' >> patch_des3.py
        from Crypto.Cipher import DES3
        original = DES3.adjust_key_parity
        def patched(key_in):
            def parity_byte(key):
                parity = 1
                for i in range(1,8):
                    parity ^= (key >> i) & 1
                return (key & 0xFE) | parity
            key_out = bytearray(key_in)
            for i in range(len(key_out)):
                key_out[i] = parity_byte(key_out[i])
            return key_out
        DES3.adjust_key_parity = patched
        EOF
        python patch_des3.py

    - name: 🚀 Run key finder
      env:
        AUTH: ${{ inputs.authenticator }}
      run: |
        sed -i "s/#find_key('abc')/find_key(os.getenv('AUTH'))/" get_iptv_channels.py
        python get_iptv_channels.py

    - name: 📤 Upload results
      uses: actions/upload-artifact@v4
      with:
        name: key-results
        path: key.txt
        retention-days: 1
