name: Find IPTV Key
on: workflow_dispatch
jobs:
  find_key:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: 🐍 Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: 🔧 Patch DES3.py
      run: |
        # 定位DES3.py文件路径
        DES3_PATH=$(python -c "from Crypto.Cipher import DES3; print(DES3.__file__)")
        echo "找到DES3.py路径: $DES3_PATH"
        
        # 备份原文件
        sudo cp $DES3_PATH ${DES3_PATH}.bak
        
        # 注释掉关键检查
        sudo sed -i '/if key_out$$:8$$ == key_out$$8:16$$ or key_out$$-16:-8$$ == key_out$$-8:$$:/,/raise ValueError("Triple DES key degenerates to single DES")/s/^/#/' $DES3_PATH
        echo "已成功注释掉检查代码"
        
        # 验证修改
        grep -A2 "if key_out$$:8$$ == key_out$$8:16$$" $DES3_PATH

    - name: 🚀 Run Script
      run: |
        pip install pycryptodome requests
        python get_iptv_channels.py
