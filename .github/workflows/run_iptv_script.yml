name: ğŸ”‘ Find IPTV Key (pycryptodomex æ–¹æ¡ˆ)

on:
  workflow_dispatch:
    inputs:
      authenticator:
        description: "è¾“å…¥æŠ“åŒ…è·å–çš„ Authenticator å€¼"
        required: true
        type: string

jobs:
  find_key:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # æœ€é•¿è¿è¡Œ6å°æ—¶

    steps:
    - name: ğŸ› ï¸ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ è®¾ç½® Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: ğŸ”„ æ›¿æ¢åŠ å¯†åº“
      run: |
        # å¸è½½åŸç‰ˆå¹¶å®‰è£…æ›¿ä»£åº“
        pip uninstall -y pycryptodome 2> /dev/null || true
        pip install pycryptodomex requests

        # ä¿®æ”¹è„šæœ¬ä¸­çš„å¯¼å…¥è¯­å¥
        sed -i 's/from Crypto\.Cipher import DES3/from Cryptodome.Cipher import DES3/' get_iptv_channels.py

        # éªŒè¯ä¿®æ”¹æ˜¯å¦æˆåŠŸ
        if grep -q "Cryptodome.Cipher" get_iptv_channels.py; then
          echo "âœ… åŠ å¯†åº“æ›¿æ¢æˆåŠŸ"
        else
          echo "âŒ æ›¿æ¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥è„šæœ¬"
          exit 1
        fi

    - name: ğŸš€ è¿è¡Œå¯†é’¥æŸ¥æ‰¾
      env:
        AUTH_KEY: ${{ inputs.authenticator }}
      run: |
        # ç¡®ä¿è°ƒç”¨ find_key å‡½æ•°
        sed -i "s/#find_key('abc')/find_key(os.getenv('AUTH_KEY'))/" get_iptv_channels.py
        
        echo "å¼€å§‹æŸ¥æ‰¾å¯†é’¥ï¼Œå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´..."
        python get_iptv_channels.py

    - name: ğŸ“¤ ä¸Šä¼ ç»“æœ
      uses: actions/upload-artifact@v4
      with:
        name: iptv-key-results
        path: |
          key.txt
        retention-days: 1

    - name: ğŸ“ æ˜¾ç¤ºç»“æœæ‘˜è¦
      if: always()
      run: |
        echo "===== è¿è¡Œç»“æœ ====="
        if [ -f key.txt ]; then
          echo "æ‰¾åˆ°çš„å¯†é’¥ä¿¡æ¯ï¼š"
          head -n 20 key.txt
        else
          echo "âš ï¸ æœªç”Ÿæˆ key.txt æ–‡ä»¶"
        fi
